<%# Post Show Page %>
<% content_for :title, @post.title %>

<div class="container py-4">
  <!-- Back Navigation -->
  <div class="row mb-3">
    <div class="col-12">
      <%= link_to posts_path, class: "btn btn-outline-secondary btn-sm" do %>
        <i class="fas fa-arrow-left me-1"></i>
        Back to Posts
      <% end %>
    </div>
  </div>

  <!-- Post Content -->
  <div class="row">
    <div class="col-12 col-lg-8 mx-auto">
      <article class="card border-0 shadow-sm">
        <div class="card-body p-4">
          <!-- Post Header -->
          <header class="mb-4">
            <!-- Status Badge for Drafts -->
            <% if @post.draft? %>
              <div class="alert alert-warning mb-3" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Draft Post</strong> - This post is not published and only visible to you.
              </div>
            <% end %>

            <!-- Title -->
            <h1 class="display-5 fw-bold text-dark mb-3">
              <%= @post.title %>
            </h1>

            <!-- Author Info and Meta -->
            <div class="d-flex justify-content-between align-items-start mb-4">
              <div class="d-flex align-items-center">
                <div class="me-3">
                  <%= image_tag @post.user.avatar_url(:medium), 
                        class: "rounded-circle", 
                        style: "width: 60px; height: 60px; object-fit: cover;" %>
                </div>
                <div>
                  <h6 class="mb-1 text-dark">
                    <%= link_to @post.user.full_name, "#", 
                          class: "text-decoration-none text-dark" %>
                  </h6>
                  <div class="text-muted small">
                    <div>Published <%= @post.formatted_created_at %></div>
                    <div class="d-flex align-items-center mt-1">
                      <span class="me-3">
                        <i class="fas fa-clock me-1"></i>
                        <%= @post.reading_time %>
                      </span>
                      <span>
                        <i class="fas fa-align-left me-1"></i>
                        <%= pluralize(@post.word_count, 'word') %>
                      </span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Action Buttons for Post Owner -->
              <% if current_user == @post.user %>
                <div class="dropdown">
                  <button class="btn btn-outline-secondary btn-sm dropdown-toggle" 
                          type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-cog"></i>
                    Manage
                  </button>
                  <ul class="dropdown-menu">
                    <li>
                      <%= link_to edit_post_path(@post), class: "dropdown-item" do %>
                        <i class="fas fa-edit me-2"></i>
                        Edit Post
                      <% end %>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <% if @post.published? %>
                      <li>
                        <%= button_to unpublish_post_path(@post), 
                              method: :post,
                              class: "dropdown-item btn btn-link p-0 text-start",
                              style: "border: none; background: none;",
                              data: { 
                                confirm: "Move this post to drafts?" 
                              } do %>
                          <i class="fas fa-eye-slash me-2"></i>
                          Move to Drafts
                        <% end %>
                      </li>
                    <% else %>
                      <li>
                        <%= button_to publish_post_path(@post), 
                              method: :post,
                              class: "dropdown-item btn btn-link p-0 text-start",
                              style: "border: none; background: none;" do %>
                          <i class="fas fa-eye me-2"></i>
                          Publish Post
                        <% end %>
                      </li>
                    <% end %>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                      <%= link_to confirm_delete_post_path(@post), 
                            class: "dropdown-item text-danger" do %>
                        <i class="fas fa-trash me-2"></i>
                        Delete Post
                      <% end %>
                    </li>
                  </ul>
                </div>
              <% end %>
            </div>

            <!-- Status Badge -->
            <div class="mb-4">
              <span class="badge bg-<%= @post.status == 'published' ? 'success' : 'secondary' %> fs-6">
                <i class="fas fa-<%= @post.status == 'published' ? 'eye' : 'file-alt' %> me-1"></i>
                <%= @post.status.titleize %>
              </span>
            </div>
          </header>

          <!-- Post Body -->
          <div class="post-content rich-text-content">
            <%= @post.body&.html_safe %>
          </div>
        </div>
      </article>

      <!-- Post Footer -->
      <div class="mt-4">
        <div class="card border-0 bg-light">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-6">
                <small class="text-muted">
                  <i class="fas fa-calendar me-1"></i>
                  Created: <%= @post.formatted_created_at %>
                  <% if @post.updated_at != @post.created_at %>
                    <br>
                    <i class="fas fa-edit me-1"></i>
                    Last updated: <%= @post.formatted_updated_at %>
                  <% end %>
                </small>
              </div>
              <div class="col-md-6 text-md-end">
                <div class="d-flex justify-content-md-end gap-2">
                  <%= link_to posts_path, class: "btn btn-outline-primary btn-sm" do %>
                    <i class="fas fa-list me-1"></i>
                    All Posts
                  <% end %>
                  <% if user_signed_in? && current_user != @post.user %>
                    <button class="btn btn-outline-success btn-sm" disabled>
                      <i class="fas fa-heart me-1"></i>
                      Like
                    </button>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Comments Section -->
      <div class="mt-5">
        <div class="card border-0 shadow-sm">
          <div class="card-header bg-white border-bottom">
            <h5 class="mb-0">
              <i class="fas fa-comments me-2 text-primary"></i>
              Comments (<%= @post.comments_count %>)
            </h5>
          </div>
          
          <!-- Comment Form (for authenticated users) -->
          <% if user_signed_in? && @post.can_be_commented_by?(current_user) %>
            <div class="card-body border-bottom">
              <h6 class="mb-3">
                <i class="fas fa-pen me-1"></i>
                Leave a Comment
              </h6>
              
              <%= form_with model: [@post, @post.comments.build], 
                    local: true, 
                    class: "comment-form" do |form| %>
                
                <div class="d-flex align-items-start gap-3">
                  <!-- User Avatar -->
                  <div class="flex-shrink-0">
                    <%= image_tag current_user.avatar_url(:small), 
                          class: "rounded-circle", 
                          style: "width: 40px; height: 40px; object-fit: cover;" %>
                  </div>
                  
                  <!-- Comment Input -->
                  <div class="flex-grow-1">
                    <%= form.text_area :content, 
                          class: "form-control", 
                          rows: 3,
                          placeholder: "Share your thoughts about this post...",
                          required: true,
                          maxlength: 1000 %>
                    <div class="form-text">
                      <small class="text-muted">
                        <span id="comment-count">0</span>/1000 characters
                      </small>
                    </div>
                    <div class="mt-2">
                      <%= form.submit "Post Comment", 
                            class: "btn btn-primary btn-sm" %>
                      <button type="button" 
                              class="btn btn-outline-secondary btn-sm ms-2"
                              onclick="document.getElementById('comment_content').value = ''; updateCommentCount();">
                        Clear
                      </button>
                    </div>
                  </div>
                </div>
              <% end %>
            </div>
          <% elsif !user_signed_in? %>
            <!-- Sign in prompt for guests -->
            <div class="card-body border-bottom bg-light">
              <div class="text-center py-3">
                <i class="fas fa-sign-in-alt fa-2x text-muted mb-2"></i>
                <p class="text-muted mb-2">Join the conversation!</p>
                <%= link_to "Sign In to Comment", new_user_session_path, 
                      class: "btn btn-primary btn-sm" %>
              </div>
            </div>
          <% end %>
          
          <!-- Comments List -->
          <div class="card-body">
            <% if @post.has_comments? %>
              <div class="comments-list">
                <% @post.comments.oldest_first.includes(:user).each_with_index do |comment, index| %>
                  <div class="comment-item <%= 'border-bottom' if index < @post.comments.count - 1 %> pb-3 <%= 'mb-3' if index < @post.comments.count - 1 %>" 
                       id="comment-<%= comment.id %>">
                    
                    <div class="d-flex align-items-start gap-3">
                      <!-- Commenter Avatar -->
                      <div class="flex-shrink-0">
                        <%= image_tag comment.user.avatar_url(:small), 
                              class: "rounded-circle", 
                              style: "width: 40px; height: 40px; object-fit: cover;" %>
                      </div>
                      
                      <!-- Comment Content -->
                      <div class="flex-grow-1">
                        <!-- Comment Header -->
                        <div class="d-flex justify-content-between align-items-center mb-2">
                          <div>
                            <h6 class="mb-0 text-dark">
                              <%= comment.user.display_name %>
                              <% if comment.user == @post.user %>
                                <span class="badge bg-primary ms-1" title="Post Author">Author</span>
                              <% end %>
                            </h6>
                            <small class="text-muted">
                              <i class="fas fa-clock me-1"></i>
                              <%= comment.time_ago %> • <%= comment.formatted_created_at %>
                            </small>
                          </div>
                          
                          <!-- Comment Actions -->
                          <% if user_signed_in? %>
                            <div class="dropdown">
                              <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                      type="button" data-bs-toggle="dropdown">
                                <i class="fas fa-ellipsis-h"></i>
                              </button>
                              <ul class="dropdown-menu dropdown-menu-end">
                                <% if comment.can_be_edited_by?(current_user) %>
                                  <li>
                                    <%= link_to edit_comment_path(comment), 
                                          class: "dropdown-item" do %>
                                      <i class="fas fa-edit me-2"></i>
                                      Edit Comment
                                    <% end %>
                                  </li>
                                <% end %>
                                <% if comment.can_be_deleted_by?(current_user) %>
                                  <li>
                                    <%= button_to comment_path(comment), 
                                          method: :delete, 
                                          class: "dropdown-item text-danger btn btn-link p-0 text-start",
                                          style: "border: none; background: none;",
                                          data: { 
                                            confirm: "Are you sure you want to delete this comment?" 
                                          } do %>
                                      <i class="fas fa-trash me-2"></i>
                                      Delete Comment
                                    <% end %>
                                  </li>
                                <% end %>
                                <% unless comment.user == current_user %>
                                  <li><hr class="dropdown-divider"></li>
                                  <li>
                                    <%= link_to report_comment_path(comment), 
                                          method: :post,
                                          class: "dropdown-item text-warning",
                                          data: { 
                                            confirm: "Report this comment for inappropriate content?" 
                                          } do %>
                                      <i class="fas fa-flag me-2"></i>
                                      Report Comment
                                    <% end %>
                                  </li>
                                <% end %>
                              </ul>
                            </div>
                          <% end %>
                        </div>
                        
                        <!-- Comment Text -->
                        <div class="comment-content">
                          <%= simple_format(comment.content, class: "mb-0 text-dark") %>
                        </div>
                        
                        <!-- Comment Meta -->
                        <div class="mt-2">
                          <small class="text-muted">
                            <%= pluralize(comment.word_count, 'word') %> • 
                            <%= comment.character_count %> characters
                          </small>
                        </div>
                      </div>
                    </div>
                  </div>
                <% end %>
              </div>
            <% else %>
              <!-- No Comments State -->
              <div class="text-center py-5">
                <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                <h5 class="text-muted mb-2">No comments yet</h5>
                <p class="text-muted mb-0">
                  <% if user_signed_in? && @post.can_be_commented_by?(current_user) %>
                    Be the first to share your thoughts about this post!
                  <% else %>
                    Sign in to start the conversation.
                  <% end %>
                </p>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- JavaScript for Comment Form -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const commentTextarea = document.getElementById('comment_content');
  const commentCount = document.getElementById('comment-count');
  
  function updateCommentCount() {
    if (commentTextarea && commentCount) {
      commentCount.textContent = commentTextarea.value.length;
    }
  }
  
  if (commentTextarea) {
    commentTextarea.addEventListener('input', updateCommentCount);
    updateCommentCount(); // Initial count
  }
  
  // Make updateCommentCount available globally for the Clear button
  window.updateCommentCount = updateCommentCount;
});
</script>

<!-- Custom CSS for Post Content -->
<style>
  .post-content {
    font-size: 1.1rem;
    line-height: 1.8;
    color: #2c3e50;
  }
  
  .rich-text-content {
    font-size: 1.1rem;
    line-height: 1.8;
    color: #2c3e50;
  }
  
  .rich-text-content h1 {
    font-size: 2rem;
    font-weight: 600;
    margin: 2rem 0 1rem 0;
    color: #212529;
    border-bottom: 2px solid #e9ecef;
    padding-bottom: 0.5rem;
  }

  .rich-text-content h2 {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 1.75rem 0 0.75rem 0;
    color: #212529;
  }

  .rich-text-content h3 {
    font-size: 1.25rem;
    font-weight: 600;
    margin: 1.5rem 0 0.5rem 0;
    color: #212529;
  }

  .rich-text-content p {
    margin-bottom: 1.5rem;
  }

  .rich-text-content strong {
    font-weight: 600;
    color: #212529;
  }

  .rich-text-content em {
    font-style: italic;
  }

  .rich-text-content u {
    text-decoration: underline;
  }

  .rich-text-content s {
    text-decoration: line-through;
  }

  .rich-text-content a {
    color: #0d6efd;
    text-decoration: none;
    border-bottom: 1px solid transparent;
    transition: all 0.2s ease;
  }

  .rich-text-content a:hover {
    color: #0a58ca;
    border-bottom-color: #0a58ca;
  }

  .rich-text-content ul, 
  .rich-text-content ol {
    margin: 1.5rem 0;
    padding-left: 2rem;
  }

  .rich-text-content li {
    margin-bottom: 0.75rem;
  }

  .rich-text-content blockquote {
    margin: 2rem 0;
    padding: 1.5rem 2rem;
    border-left: 4px solid #0d6efd;
    background: linear-gradient(to right, #f8f9fa, transparent);
    font-style: italic;
    font-size: 1.05em;
    border-radius: 0 0.5rem 0.5rem 0;
  }

  .rich-text-content pre {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.5rem;
    padding: 1.5rem;
    margin: 2rem 0;
    overflow-x: auto;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.9rem;
    line-height: 1.4;
  }

  .rich-text-content code {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 0.2rem 0.4rem;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.875rem;
    color: #e83e8c;
  }

  .rich-text-content hr {
    border: none;
    border-top: 2px solid #dee2e6;
    margin: 3rem 0;
    opacity: 0.7;
  }
  
  .post-content p {
    margin-bottom: 1.5rem;
  }
  
  .display-5 {
    line-height: 1.2;
  }
  
  .card {
    border-radius: 12px;
  }
  
  .badge {
    font-weight: 500;
  }
  
  .lead {
    font-weight: 400;
  }
  
  .dropdown-item:hover {
    background-color: #f8f9fa;
  }
  
  .text-danger:hover {
    background-color: #f8d7da !important;
  }
</style>
