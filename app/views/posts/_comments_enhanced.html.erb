<!-- Enhanced Comments Section -->
<div class="comments-section mt-5">
  <div class="comments-header mb-4">
    <h4 class="d-flex align-items-center">
      <i class="fas fa-comments text-primary me-2"></i>
      Comments 
      <span class="badge bg-primary ms-2"><%= @post.comments.count %></span>
    </h4>
    <p class="text-muted mb-0">Share your thoughts and engage with the community</p>
  </div>

  <!-- Comment Form -->
  <% if user_signed_in? %>
    <div class="comment-form-section mb-5">
      <div class="card border-0 shadow-sm">
        <div class="card-header bg-light">
          <div class="d-flex align-items-center">
            <%= image_tag current_user.avatar_url(:small), 
                class: "rounded-circle me-3", 
                style: "width: 40px; height: 40px;" %>
            <div>
              <h6 class="mb-0"><%= current_user.display_name %></h6>
              <small class="text-muted">Add your comment</small>
            </div>
          </div>
        </div>
        <div class="card-body">
          <%= form_with model: [@post, Comment.new], local: true, class: "comment-form" do |f| %>
            <div class="mb-3">
              <%= f.text_area :content, 
                  class: "form-control", 
                  rows: 4, 
                  placeholder: "What are your thoughts on this post?",
                  required: true %>
              <div class="form-text text-muted">
                <i class="fas fa-info-circle me-1"></i>
                Be respectful and constructive in your comments
              </div>
            </div>
            
            <div class="d-flex justify-content-between align-items-center">
              <div class="comment-guidelines">
                <small class="text-muted">
                  <i class="fas fa-heart me-1 text-danger"></i>
                  Be kind and respectful
                </small>
              </div>
              <div>
                <button type="button" class="btn btn-outline-secondary me-2" onclick="clearCommentForm()">
                  <i class="fas fa-times me-1"></i>
                  Clear
                </button>
                <%= f.submit "Post Comment", class: "btn btn-primary" do %>
                  <i class="fas fa-paper-plane me-1"></i>
                  Post Comment
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  <% else %>
    <!-- Login Prompt -->
    <div class="text-center py-4 mb-5">
      <div class="card border-0 bg-light">
        <div class="card-body">
          <i class="fas fa-sign-in-alt fa-3x text-muted mb-3"></i>
          <h5 class="text-muted mb-3">Join the Discussion</h5>
          <p class="text-muted mb-3">Sign in to share your thoughts and engage with other readers</p>
          <%= link_to "Sign In to Comment", new_user_session_path, class: "btn btn-primary me-2" %>
          <%= link_to "Create Account", new_user_registration_path, class: "btn btn-outline-primary" %>
        </div>
      </div>
    </div>
  <% end %>

  <!-- Comments List -->
  <div class="comments-list">
    <% if @post.comments.any? %>
      <div class="comments-count-info mb-4">
        <div class="d-flex justify-content-between align-items-center">
          <span class="text-muted">
            <i class="fas fa-comment-dots me-1"></i>
            <%= pluralize(@post.comments.count, 'comment') %> â€¢ 
            Sorted by newest first
          </span>
          <div class="btn-group btn-group-sm" role="group">
            <input type="radio" class="btn-check" name="commentSort" id="newest" autocomplete="off" checked>
            <label class="btn btn-outline-secondary" for="newest">Newest</label>

            <input type="radio" class="btn-check" name="commentSort" id="oldest" autocomplete="off">
            <label class="btn btn-outline-secondary" for="oldest">Oldest</label>
          </div>
        </div>
      </div>

      <div id="commentsContainer">
        <% @post.comments.order(created_at: :desc).each_with_index do |comment, index| %>
          <div class="comment-item <%= 'comment-highlight' if comment.user == current_user %> mb-4" 
               data-comment-id="<%= comment.id %>"
               data-created-at="<%= comment.created_at.to_i %>">
            
            <div class="card border-0 shadow-sm">
              <div class="card-body">
                <!-- Comment Header -->
                <div class="comment-header d-flex justify-content-between align-items-start mb-3">
                  <div class="d-flex align-items-center">
                    <%= image_tag comment.user.avatar_url(:small), 
                        class: "rounded-circle me-3", 
                        style: "width: 45px; height: 45px;" %>
                    <div>
                      <h6 class="mb-0">
                        <%= comment.user.display_name %>
                        <% if comment.user == @post.user %>
                          <span class="badge bg-primary ms-2">Author</span>
                        <% end %>
                        <% if comment.user == current_user %>
                          <span class="badge bg-success ms-2">You</span>
                        <% end %>
                      </h6>
                      <small class="text-muted">
                        <i class="far fa-clock me-1"></i>
                        <%= time_ago_in_words(comment.created_at) %> ago
                        <% if comment.created_at != comment.updated_at %>
                          <span class="text-info ms-2">
                            <i class="fas fa-edit me-1"></i>
                            edited
                          </span>
                        <% end %>
                      </small>
                    </div>
                  </div>

                  <!-- Comment Actions -->
                  <% if user_signed_in? %>
                    <div class="dropdown">
                      <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                              type="button" 
                              data-bs-toggle="dropdown">
                        <i class="fas fa-ellipsis-h"></i>
                      </button>
                      <ul class="dropdown-menu">
                        <% if current_user == comment.user %>
                          <li>
                            <%= link_to edit_comment_path(comment), class: "dropdown-item" do %>
                              <i class="fas fa-edit me-2"></i>
                              Edit Comment
                            <% end %>
                          </li>
                          <li>
                            <%= link_to comment_path(comment), 
                                method: :delete, 
                                class: "dropdown-item text-danger",
                                data: { 
                                  confirm: "Are you sure you want to delete this comment?",
                                  turbo_method: :delete
                                } do %>
                              <i class="fas fa-trash me-2"></i>
                              Delete Comment
                            <% end %>
                          </li>
                          <li><hr class="dropdown-divider"></li>
                        <% end %>
                        <li>
                          <%= link_to report_comment_path(comment), 
                              method: :post,
                              class: "dropdown-item text-warning" do %>
                            <i class="fas fa-flag me-2"></i>
                            Report Comment
                          <% end %>
                        </li>
                      </ul>
                    </div>
                  <% end %>
                </div>

                <!-- Comment Content -->
                <div class="comment-content">
                  <p class="mb-3"><%= simple_format(comment.content) %></p>
                </div>

                <!-- Comment Footer -->
                <div class="comment-footer d-flex justify-content-between align-items-center">
                  <div class="comment-stats text-muted small">
                    <span class="me-3">
                      <i class="fas fa-quote-left me-1"></i>
                      Comment #<%= index + 1 %>
                    </span>
                    <span class="me-3">
                      <i class="fas fa-calendar-alt me-1"></i>
                      <%= comment.created_at.strftime('%B %d, %Y') %>
                    </span>
                  </div>

                  <div class="comment-actions">
                    <% if user_signed_in? %>
                      <button class="btn btn-sm btn-outline-primary me-2" 
                              onclick="likeComment(<%= comment.id %>)" 
                              title="Like this comment">
                        <i class="far fa-thumbs-up me-1"></i>
                        <span id="like-count-<%= comment.id %>">0</span>
                      </button>
                      <button class="btn btn-sm btn-outline-secondary" 
                              onclick="replyToComment(<%= comment.id %>)" 
                              title="Reply to this comment">
                        <i class="fas fa-reply me-1"></i>
                        Reply
                      </button>
                    <% end %>
                  </div>
                </div>

                <!-- Reply Form (Hidden by default) -->
                <div class="reply-form mt-3" id="reply-form-<%= comment.id %>" style="display: none;">
                  <div class="card bg-light">
                    <div class="card-body">
                      <%= form_with model: [@post, Comment.new], local: true, class: "reply-form-inner" do |f| %>
                        <%= f.hidden_field :parent_id, value: comment.id %>
                        <div class="mb-3">
                          <%= f.text_area :content, 
                              class: "form-control form-control-sm", 
                              rows: 3, 
                              placeholder: "Write your reply...",
                              required: true %>
                        </div>
                        <div class="d-flex justify-content-end">
                          <button type="button" class="btn btn-sm btn-outline-secondary me-2" 
                                  onclick="cancelReply(<%= comment.id %>)">
                            Cancel
                          </button>
                          <%= f.submit "Post Reply", class: "btn btn-sm btn-primary" %>
                        </div>
                      <% end %>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <!-- Load More Comments -->
      <% if @post.comments.count > 10 %>
        <div class="text-center mt-4">
          <button class="btn btn-outline-primary" onclick="loadMoreComments()">
            <i class="fas fa-chevron-down me-1"></i>
            Load More Comments
          </button>
        </div>
      <% end %>
    <% else %>
      <!-- No Comments Yet -->
      <div class="text-center py-5">
        <div class="empty-comments-state">
          <i class="far fa-comments fa-5x text-muted mb-4"></i>
          <h5 class="text-muted mb-3">No comments yet</h5>
          <p class="text-muted mb-4">
            Be the first to share your thoughts on this post!
          </p>
          <% if user_signed_in? %>
            <button class="btn btn-primary" onclick="focusCommentForm()">
              <i class="fas fa-comment me-1"></i>
              Write the First Comment
            </button>
          <% else %>
            <%= link_to new_user_session_path, class: "btn btn-primary" do %>
              <i class="fas fa-sign-in-alt me-1"></i>
              Sign In to Comment
            <% end %>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Custom Styles -->
<style>
  .comment-highlight {
    background: linear-gradient(90deg, #e3f2fd 0%, transparent 100%);
    border-left: 4px solid var(--bs-primary);
  }

  .comment-item {
    transition: all 0.3s ease;
  }

  .comment-item:hover {
    transform: translateX(5px);
  }

  .comment-form textarea:focus {
    border-color: var(--bs-primary);
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
  }

  .comment-actions .btn {
    transition: all 0.2s ease;
  }

  .comment-actions .btn:hover {
    transform: scale(1.05);
  }

  .empty-comments-state i {
    animation: float 3s ease-in-out infinite;
  }

  @keyframes float {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
    100% { transform: translateY(0px); }
  }

  .reply-form {
    border-left: 3px solid var(--bs-primary);
    margin-left: 20px;
  }

  .comment-content {
    line-height: 1.6;
  }

  .comment-stats {
    opacity: 0.8;
  }

  .badge {
    font-size: 0.7em;
  }
</style>

<!-- JavaScript for Enhanced Functionality -->
<script>
  function clearCommentForm() {
    document.querySelector('.comment-form textarea').value = '';
  }

  function focusCommentForm() {
    const textarea = document.querySelector('.comment-form textarea');
    if (textarea) {
      textarea.focus();
      textarea.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
  }

  function likeComment(commentId) {
    // Implement comment liking functionality
    const likeButton = event.target.closest('button');
    const countSpan = document.getElementById(`like-count-${commentId}`);
    const currentCount = parseInt(countSpan.textContent);
    
    // Toggle liked state (this would be handled by server in real implementation)
    if (likeButton.classList.contains('btn-outline-primary')) {
      likeButton.classList.remove('btn-outline-primary');
      likeButton.classList.add('btn-primary');
      countSpan.textContent = currentCount + 1;
    } else {
      likeButton.classList.remove('btn-primary');
      likeButton.classList.add('btn-outline-primary');
      countSpan.textContent = Math.max(0, currentCount - 1);
    }
  }

  function replyToComment(commentId) {
    const replyForm = document.getElementById(`reply-form-${commentId}`);
    if (replyForm.style.display === 'none') {
      replyForm.style.display = 'block';
      replyForm.querySelector('textarea').focus();
    } else {
      replyForm.style.display = 'none';
    }
  }

  function cancelReply(commentId) {
    const replyForm = document.getElementById(`reply-form-${commentId}`);
    replyForm.style.display = 'none';
    replyForm.querySelector('textarea').value = '';
  }

  function loadMoreComments() {
    // Implement pagination for comments
    alert('Load more comments functionality will be implemented!');
  }

  // Sort comments functionality
  document.addEventListener('DOMContentLoaded', function() {
    const sortButtons = document.querySelectorAll('input[name="commentSort"]');
    sortButtons.forEach(button => {
      button.addEventListener('change', function() {
        sortComments(this.id);
      });
    });
  });

  function sortComments(sortType) {
    const container = document.getElementById('commentsContainer');
    const comments = Array.from(container.children);
    
    comments.sort((a, b) => {
      const dateA = parseInt(a.dataset.createdAt);
      const dateB = parseInt(b.dataset.createdAt);
      
      if (sortType === 'newest') {
        return dateB - dateA;
      } else {
        return dateA - dateB;
      }
    });
    
    // Re-append sorted comments
    comments.forEach(comment => container.appendChild(comment));
  }

  // Auto-expand textarea as user types
  document.addEventListener('DOMContentLoaded', function() {
    const textareas = document.querySelectorAll('.comment-form textarea, .reply-form textarea');
    textareas.forEach(textarea => {
      textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
      });
    });
  });
</script>
